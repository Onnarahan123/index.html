<!DOCTYPE html>
<html lang="et">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Elektrihind LIVE</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color: #f1f5f9;
            --card-bg: #ffffff;
            --text-main: #0f172a;
            --primary: #3b82f6;
        }
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: var(--bg-color); 
            margin: 0; padding: 10px; 
            display: flex; flex-direction: column; align-items: center; 
            color: var(--text-main);
            min-height: 100vh;
        }
        .app-container { 
            max-width: 500px; width: 100%; 
            background: var(--card-bg); 
            padding: 25px; border-radius: 28px; 
            box-shadow: 0 20px 40px -10px rgba(0,0,0,0.1); 
            margin-top: 10px; box-sizing: border-box;
        }

        /* Päis ja kell */
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .header h1 { font-size: 1.1rem; font-weight: 800; text-transform: uppercase; letter-spacing: 0.5px; margin: 0; }
        #clock { font-weight: 600; color: #64748b; font-variant-numeric: tabular-nums; }

        /* Nupud (Tabid) */
        .nav-tabs { 
            display: flex; background: #f1f5f9; padding: 5px; border-radius: 12px; margin-bottom: 25px; 
        }
        .nav-btn {
            flex: 1; border: none; background: transparent; padding: 10px; border-radius: 8px;
            font-weight: 600; color: #64748b; cursor: pointer; transition: all 0.2s; font-size: 0.95rem;
        }
        .nav-btn.active { background: white; color: var(--text-main); box-shadow: 0 2px 5px rgba(0,0,0,0.05); }

        /* Hinna kast */
        .price-card { 
            padding: 35px 20px; border-radius: 24px; text-align: center;
            margin-bottom: 25px; transition: transform 0.3s ease, background 0.5s ease;
            color: white; position: relative; overflow: hidden;
        }
        .price-label { font-size: 0.9rem; font-weight: 600; opacity: 0.9; margin-bottom: 5px; text-transform: uppercase; letter-spacing: 1px;}
        .price-value { font-size: 4.5rem; font-weight: 800; margin: 0; line-height: 1; letter-spacing: -2px; }
        .price-unit { font-size: 1.2rem; font-weight: 600; opacity: 0.9; margin-left: 5px; }
        .status-badge { 
            display: inline-block; padding: 6px 14px; border-radius: 20px; 
            background: rgba(255,255,255,0.25); backdrop-filter: blur(4px);
            font-weight: 700; font-size: 0.8rem; margin-top: 15px; 
        }

        /* Värviteemad */
        .theme-cheap { background: linear-gradient(135deg, #22c55e, #16a34a); box-shadow: 0 10px 20px rgba(22, 163, 74, 0.2); }
        .theme-normal { background: linear-gradient(135deg, #eab308, #ca8a04); box-shadow: 0 10px 20px rgba(202, 138, 4, 0.2); }
        .theme-expensive { background: linear-gradient(135deg, #ef4444, #dc2626); box-shadow: 0 10px 20px rgba(220, 38, 38, 0.2); }
        .theme-neutral { background: linear-gradient(135deg, #64748b, #475569); }

        /* Graafik */
        .chart-section { height: 260px; width: 100%; }
        
        #loader { padding: 60px 0; text-align: center; color: #64748b; font-weight: 600; }
        .footer { font-size: 0.7rem; color: #94a3b8; margin-top: 25px; text-align: center; line-height: 1.6; }
        
        /* Peida sisu laadimise ajal */
        .hidden { display: none; }
    </style>
</head>
<body>

<div class="app-container">
    <div class="header">
        <h1>Elektrihind</h1>
        <div id="clock">--:--</div>
    </div>

    <div class="nav-tabs">
        <button id="btn-today" class="nav-btn active" onclick="switchView('today')">Täna</button>
        <button id="btn-tomorrow" class="nav-btn" onclick="switchView('tomorrow')">Homme</button>
    </div>

    <div id="loader">Andmete laadimine...</div>

    <div id="content-area" class="hidden">
        <div id="price-box" class="price-card theme-neutral">
            <div id="display-label" class="price-label">Hetkehind</div>
            <div class="price-value"><span id="main-price">--</span><span class="price-unit">s/kWh</span></div>
            <div id="status-badge" class="status-badge">LAEN...</div>
        </div>

        <div class="chart-section">
            <canvas id="priceChart"></canvas>
        </div>
        
        <p id="no-data-msg" class="hidden" style="text-align: center; color: #ef4444; font-weight: 600; margin-top: 40px;">
            Homsed hinnad selguvad orienteeruvalt kell 14:00
        </p>
    </div>

    <div class="footer">
        Andmed: Elering / Nord Pool (Eesti)<br>
        Hinnad sisaldavad 22% käibemaksu
    </div>
</div>

<script>
    // Globaalsed muutujad andmete hoidmiseks
    let chartInstance;
    let globalData = { today: [], tomorrow: [] };
    let currentView = 'today'; // 'today' või 'tomorrow'

    // 1. Kell
    setInterval(() => {
        document.getElementById('clock').innerText = new Date().toLocaleTimeString('et-EE', {hour:'2-digit', minute:'2-digit'});
    }, 1000);

    // 2. Andmete tõmbamine
    async function fetchData() {
        try {
            const now = new Date();
            const start = new Date(now.getFullYear(), now.getMonth(), now.getDate()).toISOString();
            const end = new Date(now.getFullYear(), now.getMonth(), now.getDate() + 2).toISOString();
            
            const apiUrl = `https://dashboard.elering.ee/api/nps/price?start=${start}&end=${end}`;
            // Kasutame proxy-t
            const response = await fetch(`https://api.allorigins.win/get?url=${encodeURIComponent(apiUrl)}`);
            const wrapper = await response.json();
            const json = JSON.parse(wrapper.contents);
            const rawData = json.data.ee;

            processData(rawData);
        } catch (e) {
            document.getElementById('loader').innerText = "Viga ühendusega. Proovi uuesti.";
            console.error(e);
        }
    }

    // 3. Andmete töötlemine
    function processData(data) {
        const todayStr = new Date().toDateString();
        const tomorrow = new Date();
        tomorrow.setDate(tomorrow.getDate() + 1);
        const tomorrowStr = tomorrow.toDateString();

        globalData.today = [];
        globalData.tomorrow = [];

        data.forEach(item => {
            const date = new Date(item.timestamp * 1000);
            const priceWithTax = parseFloat((item.price / 10 * 1.22).toFixed(2));
            const point = { 
                hour: date.getHours(), 
                price: priceWithTax,
                timestamp: item.timestamp * 1000
            };

            if (date.toDateString() === todayStr) {
                globalData.today.push(point);
            } else if (date.toDateString() === tomorrowStr) {
                globalData.tomorrow.push(point);
            }
        });

        // Esimene laadimine
        document.getElementById('loader').classList.add('hidden');
        document.getElementById('content-area').classList.remove('hidden');
        switchView('today');
    }

    // 4. Vaate vahetamine (Nupud)
    function switchView(view) {
        currentView = view;
        
        // Nuppude stiil
        document.getElementById('btn-today').className = view === 'today' ? 'nav-btn active' : 'nav-btn';
        document.getElementById('btn-tomorrow').className = view === 'tomorrow' ? 'nav-btn active' : 'nav-btn';

        renderView();
    }

    // 5. Ekraani uuendamine
    function renderView() {
        const box = document.getElementById('price-box');
        const badge = document.getElementById('status-badge');
        const priceDisplay = document.getElementById('main-price');
        const label = document.getElementById('display-label');
        const noDataMsg = document.getElementById('no-data-msg');
        const chartCanvas = document.querySelector('.chart-section canvas');

        let dataToShow = [];
        let displayPrice = 0;
        let themeClass = 'theme-neutral';
        let badgeText = '';

        if (currentView === 'today') {
            dataToShow = globalData.today;
            noDataMsg.classList.add('hidden');
            chartCanvas.classList.remove('hidden');
            
            // Leiame hetkehinna
            const currentHour = new Date().getHours();
            const currentPoint = dataToShow.find(p => p.hour === currentHour);
            displayPrice = currentPoint ? currentPoint.price : dataToShow[dataToShow.length-1]?.price || 0;
            
            label.innerText = "HETKEHIND";
            badgeText = getStatusText(displayPrice);
            themeClass = getTheme(displayPrice);

        } else {
            // HOMME
            dataToShow = globalData.tomorrow;
            
            if (dataToShow.length === 0) {
                // Andmeid pole veel
                box.className = 'price-card theme-neutral';
                label.innerText = "HOMNE PÄEV";
                priceDisplay.innerText = "--";
                badge.innerText = "OOTEL";
                chartCanvas.classList.add('hidden'); // Peida graafik
                noDataMsg.classList.remove('hidden'); // Näita veateadet
                return; // Lõpeta siin
            }

            noDataMsg.classList.add('hidden');
            chartCanvas.classList.remove('hidden');

            // Arvuta homne keskmine
            const sum = dataToShow.reduce((acc, curr) => acc + curr.price, 0);
            displayPrice = (sum / dataToShow.length).toFixed(2);
            
            label.innerText = "HOMNE KESKMINE";
            badgeText = "PÄEVA KESKMINE";
            themeClass = getTheme(displayPrice);
        }

        // Uuenda kasti sisu
        priceDisplay.innerText = displayPrice;
        badge.innerText = badgeText;
        box.className = `price-card ${themeClass}`;

        // Joonista graafik
        drawChart(dataToShow);
    }

    // Abifunktsioonid
    function getTheme(price) {
        if (price < 10) return 'theme-cheap';
        if (price < 20) return 'theme-normal';
        return 'theme-expensive';
    }

    function getStatusText(price) {
        if (price < 10) return "SOODNE AEG ✅";
        if (price < 20) return "TAVALINE HIND ⚖️";
        return "KALLIS! ❌";
    }

    // 6. Graafiku joonistamine
    function drawChart(dataPoints) {
        const ctx = document.getElementById('priceChart').getContext('2d');
        
        if (chartInstance) chartInstance.destroy();

        const labels = dataPoints.map(p => `${p.hour}:00`);
        const prices = dataPoints.map(p => p.price);
        const currentHour = new Date().getHours();

        chartInstance = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    data: prices,
                    borderColor: '#ffffff', // Valge joon, sest taust on värviline? Ei, graafik on valgel taustal
                    borderColor: currentView === 'today' ? '#3b82f6' : '#8b5cf6', // Sinine täna, lilla homme
                    backgroundColor: (context) => {
                        const gradient = context.chart.ctx.createLinearGradient(0, 0, 0, 300);
                        if (currentView === 'today') {
                            gradient.addColorStop(0, 'rgba(59, 130, 246, 0.2)');
                            gradient.addColorStop(1, 'rgba(59, 130, 246, 0)');
                        } else {
                            gradient.addColorStop(0, 'rgba(139, 92, 246, 0.2)');
                            gradient.addColorStop(1, 'rgba(139, 92, 246, 0)');
                        }
                        return gradient;
                    },
                    borderWidth: 3,
                    fill: true,
                    tension: 0.4,
                    pointRadius: (ctx) => {
                        // Tänases vaates näita täppi praeguse tunni juures
                        if (currentView === 'today' && dataPoints[ctx.dataIndex].hour === currentHour) return 6;
                        return 0; 
                    },
                    pointBackgroundColor: '#ef4444',
                    pointBorderColor: '#fff',
                    pointBorderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false }, tooltip: {
                    callbacks: { label: (c) => ` ${c.raw} s/kWh` }
                }},
                scales: {
                    x: { 
                        grid: { display: false }, 
                        ticks: { maxTicksLimit: 8, font: {size: 11}, color: '#94a3b8' } 
                    },
                    y: { 
                        display: false, // Peidame Y-telje numbrid puhtama vaate jaoks
                        min: 0 
                    } 
                },
                interaction: {
                    mode: 'index',
                    intersect: false,
                }
            }
        });
    }

    // Käivita
    fetchData();
    // Värskenda iga 10 min tagant
    setInterval(fetchData, 600000); 

</script>
</body>
</html>
