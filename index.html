<!DOCTYPE html>
<html lang="et">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Nutikas Elekter</title>
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="https://img.icons8.com/color/180/wind-turbine.png">

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3.0.1/dist/chartjs-plugin-annotation.min.js"></script>

    <style>
        :root {
            --primary: #4CAF50;
            --bg: #f4f6f8;
            --card: #ffffff;
            --text: #1d1d1f;
            --muted: #86868b;
            --danger: #FF3B30;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg);
            margin: 0;
            padding: 20px;
            color: var(--text);
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            -webkit-font-smoothing: antialiased;
        }

        .container { width: 100%; max-width: 500px; padding-bottom: 80px; }

        /* --- CARD --- */
        .card {
            background: var(--card);
            border-radius: 22px;
            padding: 20px;
            margin-bottom: 16px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.04);
            position: relative;
            overflow: hidden; 
            transition: all 0.5s ease;
        }

        /* --- EFEKTID (LIVE ANIMATSIOONID) --- */
        
        /* 1. AURORA (ODAV) */
        .effect-aurora {
            background: linear-gradient(120deg, #ffffff, #e8f5e9, #c8e6c9, #ffffff);
            background-size: 300% 300%;
            animation: aurora-move 8s ease infinite;
            border: 1px solid #4CAF50;
        }
        @keyframes aurora-move {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        /* 2. PULSE (KALLIS) */
        .effect-pulse {
            background: #fff;
            animation: pulse-red 4s infinite;
            border: 1px solid #ffcdd2;
        }
        @keyframes pulse-red {
            0% { box-shadow: 0 0 0 0 rgba(255, 59, 48, 0.4); border-color: #ffcdd2; }
            50% { box-shadow: 0 0 0 10px rgba(255, 59, 48, 0); border-color: #ef5350; }
            100% { box-shadow: 0 0 0 0 rgba(255, 59, 48, 0); border-color: #ffcdd2; }
        }

        h2 { 
            font-size: 13px; font-weight: 700; text-transform: uppercase; 
            color: var(--muted); margin: 0 0 12px 0; letter-spacing: 0.8px; 
        }

        /* HERO */
        .hero { text-align: center; padding-bottom: 15px; }
        .hero-time { 
            background: rgba(0,0,0,0.05); color: #444; 
            padding: 4px 12px; border-radius: 20px; 
            font-size: 13px; font-weight: 600; display: inline-block; margin-bottom: 5px;
        }
        .hero-price { font-size: 72px; font-weight: 800; line-height: 1; letter-spacing: -2px; color: var(--primary); transition: color 0.3s; }
        .hero-unit { font-size: 16px; color: var(--muted); font-weight: 500; margin-top: 5px; }

        /* V√ïRDLUS */
        .compare-grid { display: flex; gap: 10px; margin-top: 20px; }
        .comp-box { flex: 1; background: rgba(255,255,255,0.7); padding: 12px; border-radius: 14px; text-align: center; border: 1px solid rgba(0,0,0,0.05); }
        .comp-title { font-size: 11px; color: var(--muted); text-transform: uppercase; font-weight: 600; }
        .comp-val { font-size: 18px; font-weight: 700; margin-top: 4px; display: block; }
        .diff-tag { font-size: 12px; font-weight: 700; padding: 2px 6px; border-radius: 6px; margin-top: 4px; display: inline-block; }
        .diff-up { background: #ffebee; color: var(--danger); }
        .diff-down { background: #e8f5e9; color: var(--primary); }

        /* GRAAFIK */
        .chart-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .chart-box { height: 320px; width: 100%; position: relative; }
        .toggle-day { background: #eee; border: none; padding: 6px 12px; border-radius: 8px; font-size: 13px; font-weight: 600; color: #555; cursor: pointer; }

        /* LISTID */
        .list-row { display: flex; gap: 15px; }
        .list-col { flex: 1; }
        .list-header { font-size: 12px; font-weight: 700; margin-bottom: 8px; display: flex; align-items: center; gap: 5px; }
        .item-row { display: flex; justify-content: space-between; font-size: 13px; padding: 6px 0; border-bottom: 1px solid #f0f0f0; }
        .price-good { color: var(--primary); font-weight: 600; }
        .price-bad { color: var(--danger); font-weight: 600; }

        /* ILM */
        .weather-row { display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px; }
        .w-text { font-size: 14px; font-weight: 600; }
        .w-hint { background: #e3f2fd; color: #1565c0; padding: 10px; border-radius: 10px; font-size: 13px; margin-top: 10px; line-height: 1.4; }

        /* KALKULAATOR */
        .preset-row { display: flex; gap: 8px; margin-bottom: 15px; }
        .preset-btn { flex: 1; background: #f5f5f7; border: none; padding: 10px; border-radius: 12px; font-size: 20px; cursor: pointer; }
        .calc-input-row { display: flex; justify-content: space-between; align-items: center; font-weight: 600; }
        .calc-input { width: 80px; padding: 8px; border-radius: 8px; border: 1px solid #ddd; text-align: center; font-size: 16px; font-weight: 600; }

        /* MUUD */
        .notify-btn { width: 100%; padding: 12px; background: #eee; border: none; border-radius: 12px; font-weight: 600; color: #333; margin-top: 5px; cursor: pointer; }
        .notify-btn.active { background: var(--primary); color: white; }
        #loader { text-align: center; color: var(--muted); padding: 40px; }
        .hidden { display: none !important; }
        .last-update { text-align: center; color: #ccc; font-size: 10px; margin-top: 5px; }
    </style>
</head>
<body>

<div class="container">

    <div class="card hero" id="hero-card">
        <div id="loader">Laen andmeid...</div>
        <div id="main-content" class="hidden">
            <div id="current-time" class="hero-time">--:--</div>
            <div id="current-price" class="hero-price">--</div>
            <div class="hero-unit">senti / kWh (KM 24%)</div>

            <div class="compare-grid">
                <div class="comp-box">
                    <div class="comp-title">T√§na keskmine</div>
                    <div id="avg-today" class="comp-val">--</div>
                </div>
                <div class="comp-box">
                    <div class="comp-title">Homme keskmine</div>
                    <div id="avg-tomorrow" class="comp-val">--</div>
                    <div id="diff-tag" class="hidden"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="card">
        <div class="chart-header">
            <h2>Hinnagraafik</h2>
            <select id="day-select" class="toggle-day" onchange="renderChart()">
                <option value="today">T√§na</option>
                <option value="tomorrow">Homme</option>
            </select>
        </div>
        <div class="chart-box">
            <canvas id="priceChart"></canvas>
            <div id="no-data-msg" class="hidden" style="position:absolute; top:40%; left:0; right:0; text-align:center; color:#888;">
                Andmed puuduvad.<br>Homsed hinnad selguvad ~14:00
            </div>
        </div>
    </div>

    <div class="card">
        <h2>Soodne ja Kallis</h2>
        <div class="list-row">
            <div class="list-col">
                <div class="list-header" style="color:var(--primary)">üü¢ Soodne</div>
                <div id="list-cheap"></div>
            </div>
            <div class="list-col">
                <div class="list-header" style="color:var(--danger)">üî¥ Kallis</div>
                <div id="list-expensive"></div>
            </div>
        </div>
    </div>

    <div class="card">
        <h2>Ilm ja Seosed (V√µru)</h2>
        <div id="weather-box">
            <div style="color:#999;">Laen ilmainfot...</div>
        </div>
    </div>

    <div class="card">
        <h2>Kalkulaator</h2>
        <div class="preset-row">
            <button class="preset-btn" onclick="setWatts(10)">üí°</button>
            <button class="preset-btn" onclick="setWatts(2000)">üß∫</button>
            <button class="preset-btn" onclick="setWatts(9000)">üßñ</button>
            <button class="preset-btn" onclick="setWatts(11000)">üöó</button>
        </div>
        <div class="calc-input-row">
            <span>V√µimsus (W):</span>
            <input type="number" id="watts" value="2000" class="calc-input" oninput="calc()">
        </div>
        <div style="text-align:right; margin-top:10px; font-size:15px; font-weight:600;" id="calc-result">...</div>
    </div>

    <div class="card">
        <h2>Teavitused</h2>
        <div style="font-size:13px; color:#666; margin-bottom:10px;">
            Teavita, kui hind on odav (< 5s) v√µi kui homme on kallim.
        </div>
        <button id="btn-notify" class="notify-btn" onclick="toggleNotify()">Luba teavitused</button>
    </div>

    <div class="last-update" id="last-update-text"></div>
    <div style="text-align:center; color:#ccc; font-size:11px; margin-top:5px; margin-bottom:20px;">
        Made by Ranno ‚Ä¢ v3.4 Live Effects
    </div>

</div>

<script>
    const VAT = 1.24; 
    const LOW_PRICE = 5; 
    const HIGH_PRICE = 15; // Piir, kust algab "Kallis" (punane efekt)

    let appData = { today: [], tomorrow: [], currentPrice: 0 };
    let chartInstance = null;
    let notifyEnabled = false;
    let lastLoadedHour = -1;

    document.addEventListener("DOMContentLoaded", () => {
        init();
        if (Notification.permission === "granted") { notifyEnabled = true; updateNotifyBtn(); }
        
        document.addEventListener("visibilitychange", () => { if (document.visibilityState === "visible") checkAndReload(); });
        window.addEventListener("focus", checkAndReload);
        setInterval(checkAndReload, 60000);
    });

    function checkAndReload() {
        const currentHour = new Date().getHours();
        if (lastLoadedHour !== -1 && currentHour !== lastLoadedHour) window.location.reload(); 
        else getElectricity(); // Taustav√§rskendus
    }

    async function init() {
        await Promise.all([getElectricity(), getWeather()]);
        lastLoadedHour = new Date().getHours();
        const now = new Date();
        document.getElementById('last-update-text').innerText = "Viimati kontrollitud: " + now.getHours().toString().padStart(2,'0') + ":" + now.getMinutes().toString().padStart(2,'0');
    }

    async function getElectricity() {
        const now = new Date();
        const start = new Date(now.getFullYear(), now.getMonth(), now.getDate()).toISOString();
        const end = new Date(now.getFullYear(), now.getMonth(), now.getDate() + 2).toISOString();
        const apiURL = `https://dashboard.elering.ee/api/nps/price?start=${start}&end=${end}`;

        const proxy1 = `https://corsproxy.io/?${encodeURIComponent(apiURL)}`;
        const proxy2 = `https://api.allorigins.win/raw?url=${encodeURIComponent(apiURL)}`;

        let rawData = null;
        try {
            const r = await fetch(proxy1);
            if(r.ok) { const j = await r.json(); rawData = j.data.ee; } else throw new Error();
        } catch (e) {
            try {
                const r2 = await fetch(proxy2);
                if(r2.ok) { const j2 = await r2.json(); rawData = j2.data.ee; }
            } catch (e2) {
                document.getElementById('loader').innerText = "Viga √ºhenduses.";
                return;
            }
        }
        if(rawData) processElectricity(rawData);
    }

    function processElectricity(data) {
        const todayStr = new Date().toDateString();
        const tmrwStr = new Date(new Date().setDate(new Date().getDate() + 1)).toDateString();

        appData.today = data.filter(d => new Date(d.timestamp*1000).toDateString() === todayStr);
        appData.tomorrow = data.filter(d => new Date(d.timestamp*1000).toDateString() === tmrwStr);

        document.getElementById('loader').classList.add('hidden');
        document.getElementById('main-content').classList.remove('hidden');

        updateHero();
        renderChart();
        updateLists('today');
        calc();
    }

    function updateHero() {
        const nowTs = Math.floor(Date.now()/1000/3600)*3600;
        const curr = appData.today.find(d => d.timestamp === nowTs);
        const card = document.getElementById('hero-card');
        const priceEl = document.getElementById('current-price');
        
        // Eemalda vanad efektid
        card.classList.remove('effect-aurora', 'effect-pulse');

        if(curr) {
            const price = (curr.price / 10 * VAT);
            appData.currentPrice = price;
            priceEl.innerText = price.toFixed(2);
            
            const d = new Date(curr.timestamp*1000);
            const h = d.getHours().toString().padStart(2,'0');
            const hNext = (d.getHours()+1).toString().padStart(2,'0');
            document.getElementById('current-time').innerText = `${h}:00 ‚Äì ${hNext}:00`;

            // RAKENDA EFEKTID
            if(price < LOW_PRICE) {
                // AURORA (Odav)
                card.classList.add('effect-aurora');
                priceEl.style.color = '#2E7D32'; 
            } else if (price > HIGH_PRICE) {
                // PULSE (Kallis)
                card.classList.add('effect-pulse');
                priceEl.style.color = '#D32F2F'; 
            } else {
                // Tavaline
                priceEl.style.color = '#1d1d1f';
            }
        }

        const avgToday = getAvg(appData.today);
        document.getElementById('avg-today').innerText = avgToday;

        if(appData.tomorrow.length > 0) {
            const avgTom = getAvg(appData.tomorrow);
            document.getElementById('avg-tomorrow').innerText = avgTom;
            const diff = ((avgTom - avgToday) / avgToday * 100).toFixed(0);
            const tag = document.getElementById('diff-tag');
            tag.classList.remove('hidden');
            tag.innerText = (diff > 0 ? "+" : "") + diff + "%";
            tag.className = diff > 0 ? "diff-tag diff-up" : "diff-tag diff-down";
        } else {
            document.getElementById('avg-tomorrow').innerText = "-";
        }
    }

    function getAvg(arr) {
        if(!arr.length) return 0;
        const sum = arr.reduce((acc, i) => acc + (i.price/10*VAT), 0);
        return (sum / arr.length).toFixed(2);
    }

    function updateLists(day) {
        const data = day === 'today' ? appData.today : appData.tomorrow;
        if(!data.length) return;
        const sorted = [...data].sort((a,b) => a.price - b.price);
        const cheap = sorted.slice(0,3);
        const exp = sorted.slice(-3).reverse();
        const render = (arr, elId, isGood) => {
            const el = document.getElementById(elId);
            el.innerHTML = arr.map(i => {
                const p = (i.price/10*VAT).toFixed(1);
                const d = new Date(i.timestamp*1000);
                const h = d.getHours().toString().padStart(2,'0');
                const cls = isGood ? 'price-good' : 'price-bad';
                return `<div class="item-row"><span>${h}:00‚Äì${(d.getHours()+1).toString().padStart(2,'0')}</span><span class="${cls}">${p} s</span></div>`;
            }).join('');
        };
        render(cheap, 'list-cheap', true);
        render(exp, 'list-expensive', false);
    }

    function renderChart() {
        const mode = document.getElementById('day-select').value;
        const data = mode === 'today' ? appData.today : appData.tomorrow;
        
        if(!data.length) {
            document.getElementById('priceChart').style.display = 'none';
            document.getElementById('no-data-msg').classList.remove('hidden');
            return;
        } else {
            document.getElementById('priceChart').style.display = 'block';
            document.getElementById('no-data-msg').classList.add('hidden');
            updateLists(mode);
        }

        const ctx = document.getElementById('priceChart').getContext('2d');
        const labels = data.map(d => new Date(d.timestamp*1000).getHours());
        const values = data.map(d => parseFloat((d.price/10*VAT).toFixed(2)));
        const avg = parseFloat(getAvg(data));
        const currentHour = new Date().getHours();

        if(chartInstance) chartInstance.destroy();

        const gradient = ctx.createLinearGradient(0, 0, 0, 400);
        gradient.addColorStop(0, 'rgba(76, 175, 80, 0.4)');
        gradient.addColorStop(1, 'rgba(76, 175, 80, 0.0)');

        chartInstance = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Hind',
                    data: values,
                    borderColor: '#4CAF50',
                    backgroundColor: gradient,
                    borderWidth: 2,
                    stepped: true,
                    fill: true,
                    // PUNKT AINULT PRAEGUSEL TUNNIL
                    pointRadius: (ctx) => {
                        if(mode === 'today' && ctx.dataIndex === currentHour) return 6;
                        return 0;
                    },
                    pointBackgroundColor: '#4CAF50',
                    pointBorderColor: '#fff',
                    pointBorderWidth: 2,
                    pointHoverRadius: 6,
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: { mode: 'index', intersect: false },
                plugins: {
                    legend: { display: false },
                    annotation: {
                        annotations: {
                            line1: {
                                type: 'line', yMin: avg, yMax: avg,
                                borderColor: 'rgba(0,0,0,0.3)', borderDash: [5,5], borderWidth: 2
                            }
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: (c) => `Hind: ${c.raw} s/kWh`
                        }
                    }
                },
                scales: {
                    x: { 
                        grid: { display:false },
                        // N√ÑITA K√ïIKI TUNDE 00..23
                        ticks: { maxTicksLimit: 25, autoSkip: false, font: {size: 10} }
                    },
                    y: { beginAtZero: true, grid: { color: '#f0f0f0' } }
                }
            }
        });
    }

    async function getWeather() {
        try {
            const r = await fetch("https://api.open-meteo.com/v1/forecast?latitude=57.848&longitude=27.014&current=temperature_2m,weather_code,wind_speed_10m");
            const j = await r.json();
            const curr = j.current;
            const temp = curr.temperature_2m;
            const wind = curr.wind_speed_10m;
            let hint = "";
            if(wind > 20) hint = "üå™ Tugev tuul ‚Äì see surub tavaliselt elektrihinda alla!";
            else if(temp < -10) hint = "‚ùÑÔ∏è K√ºlm ilm t√µstab tavaliselt tarbimist ja hinda.";
            else if(wind < 5 && temp < 5) hint = "V√§he tuult ja jahe ‚Äì hinnad v√µivad olla k√µrgemad.";
            else hint = "Ilm on stabiilne.";

            document.getElementById('weather-box').innerHTML = `
                <div class="weather-row">
                    <div class="w-text" style="display:flex; align-items:center; gap:5px;"><span style="font-size:20px;">üå°Ô∏è</span> ${temp}¬∞C</div>
                    <div class="w-text" style="display:flex; align-items:center; gap:5px;"><span style="font-size:20px;">üí®</span> ${wind} km/h</div>
                </div>
                <div class="w-hint">üí° ${hint}</div>
            `;
        } catch(e) { document.getElementById('weather-box').innerText = "Ilma info ei lae"; }
    }

    function setWatts(w) { document.getElementById('watts').value = w; calc(); }
    function calc() {
        const w = document.getElementById('watts').value;
        const price = appData.currentPrice;
        if(price) {
            const cost = (w/1000 * price).toFixed(2);
            document.getElementById('calc-result').innerHTML = `Kulu hetkel: <span style="color:var(--primary)">${cost} senti</span> / tund`;
        }
    }

    function toggleNotify() {
        if (!("Notification" in window)) return alert("Brauser ei toeta seda.");
        Notification.requestPermission().then(p => {
            if(p === "granted") { notifyEnabled = true; updateNotifyBtn(); }
        });
    }
    function updateNotifyBtn() {
        const b = document.getElementById('btn-notify');
        if(notifyEnabled) { b.innerText = "Teavitused aktiivsed ‚úÖ"; b.classList.add('active'); }
    }
</script>
</body>
</html>
