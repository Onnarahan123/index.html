<!DOCTYPE html>
<html lang="et">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Nutikas Elekter v15</title>
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="https://img.icons8.com/color/180/wind-turbine.png">

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3.0.1/dist/chartjs-plugin-annotation.min.js"></script>

    <style>
        /* --- TEEMAD --- */
        :root {
            --primary: #4CAF50;
            --bg: #F5F7FA;
            --card: #ffffff;
            --text: #1d1d1f;
            --subtext: #86868b;
            --danger: #FF3B30;
            --warning: #FF9500;
            --gold: #FFD700;
            --border: rgba(0,0,0,0.06);
            --modal-bg: rgba(255,255,255,0.98);
            --chart-grid: #E5E5EA;
            --clock-gray: #E5E5EA;
            --guru-bg: #F2F2F7;
            --appliance-bg: rgba(0,0,0,0.03);
            --slider-track: #E5E5EA;
            --info-box-bg: #F2F2F7;
        }

        [data-theme="dark"] {
            --bg: #000000;
            --card: #1C1C1E;
            --text: #FFFFFF;
            --subtext: #98989D;
            --border: rgba(255,255,255,0.1);
            --modal-bg: #1C1C1E;
            --chart-grid: #2C2C2E;
            --clock-gray: #3A3A3C;
            --guru-bg: #2C2C2E;
            --appliance-bg: rgba(255,255,255,0.08);
            --slider-track: #ffffff;
            --info-box-bg: #2C2C2E;
        }

        body.solar-mode {
            --primary: #FFD700; 
            --danger: #4CAF50;  
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg);
            margin: 0;
            padding: 20px;
            color: var(--text);
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            -webkit-font-smoothing: antialiased;
            transition: background-color 0.3s, color 0.3s;
        }

        .container { width: 100%; max-width: 500px; padding-bottom: 80px; }

        /* HEADER */
        .app-header { display: flex; justify-content: space-between; align-items: center; width: 100%; margin-bottom: 10px; padding: 0 5px; }
        .app-title { font-weight: 800; font-size: 20px; color: var(--text); letter-spacing: -0.5px; }
        .settings-btn { background: none; border: none; font-size: 22px; cursor: pointer; color: var(--subtext); }

        /* CARD */
        .card {
            background: var(--card);
            border-radius: 24px;
            padding: 20px;
            margin-bottom: 16px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.03);
            position: relative;
            overflow: hidden; 
            border: 1px solid var(--border);
        }

        .effect-aurora { border: 1px solid var(--primary); background: linear-gradient(135deg, var(--card) 0%, rgba(76, 175, 80, 0.1) 100%); }
        .effect-pulse { border: 1px solid var(--danger); background: linear-gradient(135deg, var(--card) 0%, rgba(255, 59, 48, 0.1) 100%); animation: pulse-border 3s infinite; }
        @keyframes pulse-border { 0% { box-shadow: 0 0 0 0 rgba(255, 59, 48, 0.2); } 50% { box-shadow: 0 0 0 6px rgba(255, 59, 48, 0); } 100% { box-shadow: 0 0 0 0 rgba(255, 59, 48, 0); } }

        /* HERO */
        .hero { text-align: center; padding-bottom: 15px; }
        .hero-time { font-size: 13px; font-weight: 600; color: var(--subtext); margin-bottom: 4px; }
        .hero-price { font-size: 64px; font-weight: 800; line-height: 1; letter-spacing: -3px; color: var(--text); }
        .hero-unit { font-size: 15px; color: var(--subtext); font-weight: 500; margin-top: 6px; }
        .hero-badge { font-size: 10px; text-transform: uppercase; letter-spacing: 1px; color: var(--subtext); margin-bottom: 5px; display: block; font-weight: 700; }
        
        /* GURU & SPEAKER */
        .guru-wrapper { display: flex; justify-content: center; align-items: center; gap: 8px; margin-top: 15px; }
        .guru-bubble {
            background: var(--guru-bg); border-radius: 16px; padding: 10px 15px;
            font-size: 14px; font-weight: 600; color: var(--text); display: inline-block; line-height: 1.4;
            max-width: 80%; animation: popIn 0.5s ease; text-align: left;
        }
        @keyframes popIn { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }
        
        .speaker-btn {
            background: rgba(142, 142, 147, 0.15); border: none; border-radius: 50%;
            width: 40px; height: 40px; display: flex; align-items: center; justify-content: center;
            font-size: 18px; cursor: pointer; transition: 0.2s; color: var(--text);
        }
        .speaker-btn:active { transform: scale(0.9); }
        .speaker-btn.speaking { background: var(--warning); color: white; animation: pulse-speaker 1.5s infinite; }
        @keyframes pulse-speaker { 0% { box-shadow: 0 0 0 0 rgba(255, 149, 0, 0.4); } 70% { box-shadow: 0 0 0 10px rgba(255, 149, 0, 0); } 100% { box-shadow: 0 0 0 0 rgba(255, 149, 0, 0); } }

        /* √úLEVAADE */
        .clock-weather-wrapper { display: flex; flex-direction: column; align-items: center; gap: 20px; }
        .clock-container { position: relative; width: 200px; height: 200px; }
        #clock-canvas { width: 100%; height: 100%; transform: rotate(-90deg); }
        .clock-center { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; }
        .clock-lbl { font-size: 11px; color: var(--subtext); font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; }
        .clock-val { font-size: 26px; font-weight: 700; color: var(--text); letter-spacing: -1px; line-height: 1; margin-top: 2px; }
        .clock-unit { font-size: 12px; color: var(--subtext); font-weight: 500; margin-top: 2px; }

        .weather-mini-row { display: flex; width: 100%; justify-content: space-around; padding-top: 15px; border-top: 1px solid var(--border); }
        .wm-item { text-align: center; display: flex; flex-direction: column; align-items: center; gap: 2px; }
        .wm-lbl { font-size: 10px; color: var(--subtext); text-transform: uppercase; font-weight: 700; margin-bottom: 2px; }
        .wm-icon { font-size: 18px; margin-bottom: 2px; }
        .wm-val { font-size: 14px; font-weight: 700; color: var(--text); }

        /* SOLAR */
        .solar-card { text-align: center; }
        .solar-input-row { display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px; background: var(--appliance-bg); padding: 10px; border-radius: 12px; }
        .solar-input { width: 60px; padding: 5px; border-radius: 6px; border: 1px solid #ccc; text-align: center; font-weight: 700; font-size: 16px; }
        .solar-stats { display: flex; gap: 10px; }
        .solar-stat-box { flex: 1; background: rgba(255, 215, 0, 0.1); border: 1px solid rgba(255, 215, 0, 0.3); border-radius: 12px; padding: 10px; }
        .solar-val { font-size: 18px; font-weight: 800; color: var(--text); }
        .solar-lbl { font-size: 10px; text-transform: uppercase; color: var(--subtext); font-weight: 700; margin-top: 2px; }

        /* GRAAFIK */
        .chart-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .chart-box { height: 260px; width: 100%; position: relative; }
        .toggle-day { background: rgba(142, 142, 147, 0.15); border: none; padding: 6px 12px; border-radius: 8px; font-size: 13px; font-weight: 600; color: var(--text); cursor: pointer; }

        /* KODUMASINAD */
        .appliance-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 5px; }
        .app-item { 
            background: var(--appliance-bg); padding: 12px; border-radius: 16px; 
            display: flex; flex-direction: column; align-items: center; text-align: center; 
            position: relative; cursor: pointer; transition: 0.2s; border: 2px solid transparent;
        }
        .app-item:active { transform: scale(0.98); }
        .app-item.selected { border-color: #4CAF50; background: rgba(76, 175, 80, 0.05); }
        .app-icon { font-size: 24px; margin-bottom: 5px; }
        .app-name { font-size: 11px; font-weight: 600; color: var(--subtext); text-transform: uppercase; margin-bottom: 2px; }
        .app-cost { font-size: 16px; font-weight: 700; color: var(--text); }
        .app-best { font-size: 10px; color: #4CAF50; margin-top: 2px; font-weight: 600; }
        .app-badge-expensive { color: var(--danger); }

        #app-info-box {
            margin-top: 15px; background: var(--info-box-bg); border-radius: 12px; padding: 12px;
            font-size: 13px; color: var(--text); display: none; animation: slideDown 0.3s ease;
        }
        @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        .info-title { font-weight: 700; display: block; margin-bottom: 4px; }
        
        /* LAADIJA */
        .charger-row { display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px; }
        .slider-container { width: 100%; margin-bottom: 20px; }
        input[type=range] { -webkit-appearance: none; width: 100%; background: transparent; }
        input[type=range]::-webkit-slider-thumb { 
            -webkit-appearance: none; height: 26px; width: 26px; border-radius: 50%; 
            background: #4CAF50 !important; border: 2px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.3); margin-top: -11px; cursor: pointer;
        }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 4px; background: var(--slider-track); border-radius: 2px; }
        .charge-result { text-align: center; padding: 15px; background: rgba(76, 175, 80, 0.08); border-radius: 16px; border: 1px solid rgba(76, 175, 80, 0.2); }
        .charge-time { font-size: 18px; font-weight: 700; color: #4CAF50; display: block; margin-bottom: 2px; }
        .charge-saving { font-size: 12px; color: var(--subtext); }

        h2 { font-size: 12px; font-weight: 700; text-transform: uppercase; color: var(--subtext); margin: 0 0 15px 0; letter-spacing: 1px; }
        .hidden { display: none !important; }
        #loader { text-align: center; color: var(--subtext); padding: 40px; }

        /* MODAL */
        #settings-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); z-index: 999; align-items: flex-end; backdrop-filter: blur(4px); }
        .modal-content { background: var(--modal-bg); width: 100%; border-radius: 24px 24px 0 0; padding: 30px 24px; box-shadow: 0 -10px 40px rgba(0,0,0,0.2); animation: slideUp 0.3s cubic-bezier(0.2, 0.8, 0.2, 1); max-height: 85vh; overflow-y: auto; }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        .setting-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; font-size: 15px; font-weight: 500; }
        .setting-input { width: 70px; padding: 8px; border-radius: 10px; border: none; background: rgba(142,142,147,0.15); text-align: center; font-size: 16px; color: var(--text); font-weight: 600; }
        .setting-select { padding: 8px; border-radius: 10px; border: none; background: rgba(142,142,147,0.15); font-size: 14px; color: var(--text); font-weight: 600; text-align:right;}
        .close-btn { width: 100%; padding: 16px; background: var(--text); border: none; border-radius: 16px; color: var(--card); font-weight: 700; font-size: 16px; margin-top: 10px; cursor: pointer; }
        
        .switch { position: relative; display: inline-block; width: 50px; height: 28px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 20px; width: 20px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: #4CAF50; }
        input:checked + .slider:before { transform: translateX(22px); }
    </style>
</head>
<body>

<div class="container">

    <div class="app-header">
        <div class="app-title">‚ö°Ô∏è Elekter</div>
        <button class="settings-btn" onclick="openSettings()">‚öôÔ∏è</button>
    </div>

    <div class="card hero" id="hero-card">
        <div id="loader">Laen andmeid...</div>
        <div id="main-content" class="hidden">
            <span class="hero-badge" id="price-type-badge">B√∂rsihind</span>
            <div id="current-time" class="hero-time">--:--</div>
            <div id="current-price" class="hero-price">--</div>
            <div class="hero-unit">senti / kWh (KM <span id="vat-display">24</span>%)</div>
            
            <div class="guru-wrapper">
                <div class="guru-bubble" id="guru-text">...</div>
                <button id="guru-speaker-btn" class="speaker-btn" onclick="playGuruAudio()">üîä</button>
            </div>
        </div>
    </div>

    <div class="card">
        <div class="clock-weather-wrapper">
            <div class="clock-container">
                <canvas id="clock-canvas"></canvas>
                <div class="clock-center">
                    <div class="clock-lbl">Keskmine</div>
                    <div class="clock-val" id="day-avg">--</div>
                    <div class="clock-unit">s/kWh</div>
                </div>
            </div>
            <div class="weather-mini-row">
                <div class="wm-item"><span class="wm-lbl">Temp</span><span class="wm-icon">üå°Ô∏è</span><span class="wm-val" id="w-temp">--¬∞</span></div>
                <div class="wm-item"><span class="wm-lbl">Tuul</span><span class="wm-icon">üí®</span><span class="wm-val" id="w-wind">--</span></div>
                <div class="wm-item"><span class="wm-lbl">P√§ike</span><span class="wm-icon" id="w-solar-icon">‚òÄÔ∏è</span><span class="wm-val" id="w-solar">--</span></div>
            </div>
        </div>
    </div>

    <div class="card solar-card" id="solar-box" style="display:none;">
        <h2>Minu P√§ikesepark</h2>
        <div class="solar-input-row">
            <span>Pargi v√µimsus (kW):</span>
            <input type="number" id="solar-capacity" class="solar-input" value="10" onchange="updateSolarCalc()">
        </div>
        <div class="solar-stats">
            <div class="solar-stat-box"><div class="solar-val" id="solar-prod">0 kW</div><div class="solar-lbl">Tootlikkus</div></div>
            <div class="solar-stat-box"><div class="solar-val" id="solar-profit">0 ‚Ç¨/h</div><div class="solar-lbl">V√§√§rtus</div></div>
        </div>
        <div style="font-size:11px; color:var(--subtext); margin-top:10px;" id="solar-desc">S√µltub pilvisusest ja kellaajast</div>
    </div>

    <div class="card">
        <div class="chart-header">
            <h2>Hinnagraafik</h2>
            <select id="day-select" class="toggle-day" onchange="renderChart()">
                <option value="today">T√§na</option>
                <option value="tomorrow">Homme</option>
            </select>
        </div>
        <div class="chart-box">
            <canvas id="priceChart"></canvas>
            <div id="no-data-msg" class="hidden" style="position:absolute; top:40%; left:0; right:0; text-align:center; color:var(--subtext);">Andmed puuduvad</div>
        </div>
    </div>

    <div class="card">
        <h2>Kodumasinate kulu hetkel</h2>
        <div class="appliance-grid">
            <div class="app-item" onclick="showAppInfo('sauna', this)"><span class="app-icon">üßñ‚Äç‚ôÇÔ∏è</span><span class="app-name">Saun</span><span class="app-cost" id="cost-sauna">--</span><span class="app-best" id="best-sauna">--</span></div>
            <div class="app-item" onclick="showAppInfo('wash', this)"><span class="app-icon">üß∫</span><span class="app-name">Pesu+Kuivati</span><span class="app-cost" id="cost-wash">--</span><span class="app-best" id="best-wash">--</span></div>
            <div class="app-item" onclick="showAppInfo('stove', this)"><span class="app-icon">üç≥</span><span class="app-name">Pliit/Ahi</span><span class="app-cost" id="cost-stove">--</span><span class="app-best" id="best-stove">--</span></div>
            <div class="app-item" onclick="showAppInfo('car', this)"><span class="app-icon">üöó</span><span class="app-name">Auto</span><span class="app-cost" id="cost-car">--</span><span class="app-best" id="best-car">--</span></div>
        </div>
        <div id="app-info-box"><span class="info-title" id="info-title">Info</span><span id="info-text"></span></div>
    </div>

    <div class="card">
        <h2>üöó Tark Laadija</h2>
        <div class="charger-row">
            <span style="font-weight:600; font-size:14px;">Kestvus: <span style="color:#4CAF50; font-size:16px;" id="charge-duration-lbl">4</span>h</span>
        </div>
        <div class="slider-container">
            <input type="range" min="1" max="12" value="4" id="charge-slider" oninput="calcSmartCharge()">
        </div>
        <div class="charge-result">
            <span class="charge-saving" style="display:block; margin-bottom:4px;">Parim aeg alustamiseks:</span>
            <span class="charge-time" id="best-charge-time">--:--</span>
            <span class="charge-saving" id="charge-avg-price">--</span>
        </div>
    </div>

    <div style="text-align:center; color:var(--subtext); font-size:10px; margin-top:20px;">
        <span id="last-update-text"></span> ‚Ä¢ v15.0 Voice Assistant
    </div>

</div>

<div id="settings-modal">
    <div class="modal-content">
        <h2 style="font-size:18px; color:var(--text); margin-bottom:25px; border-bottom:none;">S√§tted</h2>
        
        <div class="setting-row"><span>Tume re≈æiim</span><button class="toggle-day" onclick="toggleTheme()" id="theme-toggle-btn">Auto</button></div>
        <div class="setting-row"><span>‚òÄÔ∏è P√§ikese omanik</span><label class="switch"><input type="checkbox" id="set-solar" onchange="toggleSolarSettings()"><span class="slider"></span></label></div>
        
        <div class="setting-row">
            <span>V√µrgupakett</span>
            <select id="set-network" class="setting-select">
                <option value="none">B√∂rsihind</option>
                <option value="vork1">V√µrk 1 (P√µhi)</option>
                <option value="vork2">V√µrk 2 (P√§ev/√ñ√∂)</option>
                <option value="vork3">V√µrk 3 (Keskpinge)</option>
                <option value="vork4">V√µrk 4 (P√§ev/√ñ√∂)</option>
            </select>
        </div>

        <div class="setting-row"><span>K√§ibemaks (%)</span><input type="number" id="set-vat" class="setting-input" value="24"></div>
        <div class="setting-row"><span>Odava piir (s)</span><input type="number" id="set-low" class="setting-input" value="5"></div>
        <div class="setting-row"><span>Kalli piir (s)</span><input type="number" id="set-high" class="setting-input" value="15"></div>
        
        <button class="close-btn" onclick="saveSettings()">Salvesta</button>
    </div>
</div>

<script>
    // GLOBAL
    let settings = { vat: 1.24, lowPrice: 5, highPrice: 15, theme: 'auto', network: 'none', solar: false, parkKw: 10 };
    let appData = { today: [], tomorrow: [], all: [], todayAvg: 0 };
    let weatherInfo = { wind: 0, temp: 0, cloud: 0, isDay: 0 };
    let chartInstance = null;
    let lastLoadedHour = -1;
    let isSpeaking = false; // TTS Status

    const FEE_RENEWABLE = 1.13; const FEE_EXCISE = 0.1;     
    const NETWORK_FEES = {
        'none': { day: 0, night: 0 }, 'vork1': { day: 4.76, night: 4.76 },
        'vork2': { day: 6.95, night: 3.99 }, 'vork3': { day: 3.50, night: 2.00 }, 'vork4': { day: 4.64, night: 2.72 }
    };

    document.addEventListener("DOMContentLoaded", () => {
        loadSettings(); applyTheme(); loadCache(); init();
        document.addEventListener("visibilitychange", () => { if (document.visibilityState === "visible") checkAndReload(); });
        setInterval(checkAndReload, 60000);
    });

    function checkAndReload() {
        const h = new Date().getHours();
        if (lastLoadedHour !== -1 && h !== lastLoadedHour) window.location.reload(); 
        else { updateHero(); updateSolarCalc(); }
    }

    async function init() {
        await Promise.all([getElectricity(), getWeather()]);
        lastLoadedHour = new Date().getHours();
        document.getElementById('last-update-text').innerText = "V√§rskendatud: " + new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        updateSolarCalc();
    }

    // --- VOICE ASSISTANT (TTS) ---
    function playGuruAudio() {
        if (!('speechSynthesis' in window)) {
            alert("Sinu seade ei toeta h√§√§lk√§sklusi.");
            return;
        }

        const btn = document.getElementById('guru-speaker-btn');

        if (isSpeaking) {
            window.speechSynthesis.cancel();
            isSpeaking = false;
            btn.classList.remove('speaking');
            btn.innerText = "üîä";
            return;
        }

        const now = new Date();
        const priceText = document.getElementById('current-price').innerText.replace('.', ' koma ');
        const rawGuru = document.getElementById('guru-text').innerText;
        // Eemaldame Emojid lugemise ajaks, muidu loeb neid s√µnadena
        const cleanGuru = rawGuru.replace(/([\u2700-\u27BF]|[\uE000-\uF8FF]|\uD83C[\uDC00-\uDFFF]|\uD83D[\uDC00-\uDFFF]|[\u2011-\u26FF]|\uD83E[\uDD10-\uDDFF])/g, '');
        
        const speechText = `Kell on ${now.getHours()}. Elektri hind on ${priceText} senti. ${cleanGuru}`;

        const utterance = new SpeechSynthesisUtterance(speechText);
        utterance.lang = 'et-EE'; // Eesti keel
        utterance.rate = 0.95; // Veidi rahulikum tempo
        
        utterance.onstart = () => {
            isSpeaking = true;
            btn.classList.add('speaking');
            btn.innerText = "‚è∏Ô∏è";
        };
        
        utterance.onend = () => {
            isSpeaking = false;
            btn.classList.remove('speaking');
            btn.innerText = "üîä";
        };

        utterance.onerror = () => {
            isSpeaking = false;
            btn.classList.remove('speaking');
            btn.innerText = "üîä";
        };

        window.speechSynthesis.speak(utterance);
    }

    // DATA
    async function getElectricity() {
        const now = new Date();
        const start = new Date(now.getFullYear(), now.getMonth(), now.getDate()).toISOString();
        const end = new Date(now.getFullYear(), now.getMonth(), now.getDate() + 2).toISOString();
        const apiURL = `https://dashboard.elering.ee/api/nps/price?start=${start}&end=${end}`;
        const proxies = [`https://corsproxy.io/?${encodeURIComponent(apiURL)}`, `https://api.allorigins.win/raw?url=${encodeURIComponent(apiURL)}`];

        let rawData = null;
        for (const proxy of proxies) {
            try {
                const r = await fetch(proxy);
                if (r.ok) {
                    const j = await r.json();
                    rawData = j.data ? j.data.ee : (j.contents ? JSON.parse(j.contents).data.ee : j);
                    if (rawData) break;
                }
            } catch (e) {}
        }
        if (rawData) { processElectricity(rawData); localStorage.setItem('elekter_data', JSON.stringify(rawData)); }
    }

    function loadCache() {
        const cached = localStorage.getItem('elekter_data');
        if(cached) try { processElectricity(JSON.parse(cached)); } catch(e){}
    }

    function calculateFinalPrice(item) {
        const date = new Date(item.timestamp * 1000); const hour = date.getHours();
        const isNight = (hour >= 22 || hour < 7) || (date.getDay() === 0 || date.getDay() === 6);
        let networkFee = 0;
        if (['vork2', 'vork3', 'vork4'].includes(settings.network)) { networkFee = isNight ? NETWORK_FEES[settings.network].night : NETWORK_FEES[settings.network].day; } 
        else { networkFee = NETWORK_FEES[settings.network].day; }
        const fees = (settings.network === 'none') ? 0 : (networkFee + FEE_RENEWABLE + FEE_EXCISE);
        return (item.price / 10 * settings.vat) + (fees * settings.vat);
    }

    function processElectricity(data) {
        if (!data || !Array.isArray(data)) return;
        const todayStr = new Date().toDateString(); const tmrwStr = new Date(new Date().setDate(new Date().getDate() + 1)).toDateString();
        appData.today = data.filter(d => new Date(d.timestamp*1000).toDateString() === todayStr);
        appData.tomorrow = data.filter(d => new Date(d.timestamp*1000).toDateString() === tmrwStr);
        appData.all = [...appData.today, ...appData.tomorrow];
        appData.todayAvg = getAvg(appData.today);
        document.getElementById('loader').classList.add('hidden'); document.getElementById('main-content').classList.remove('hidden');
        updateHero(); updateAppliancesMatrix(); renderClock(); calcSmartCharge(); renderChart();
    }

    function updateHero() {
        const nowTs = Math.floor(Date.now()/1000/3600)*3600;
        const curr = appData.today.find(d => d.timestamp === nowTs);
        const card = document.getElementById('hero-card');
        const priceEl = document.getElementById('current-price');
        document.getElementById('price-type-badge').innerText = settings.network === 'none' ? "B√∂rsihind" : "L√µpphind";
        card.classList.remove('effect-aurora', 'effect-pulse');

        if(curr) {
            const price = calculateFinalPrice(curr);
            priceEl.innerText = price.toFixed(2);
            document.getElementById('current-time').innerText = new Date().getHours() + ":00 ‚Äì " + (new Date().getHours()+1) + ":00";
            updateGuru(price);

            let isGood = price < settings.lowPrice; let isBad = price > settings.highPrice;
            if (settings.solar) { isGood = price > settings.highPrice; isBad = price < settings.lowPrice; }

            if(isGood) { card.classList.add('effect-aurora'); priceEl.style.color = settings.solar ? '#FFD700' : '#4CAF50'; } 
            else if (isBad) { card.classList.add('effect-pulse'); priceEl.style.color = settings.solar ? '#4CAF50' : '#FF3B30'; } 
            else { priceEl.style.color = 'var(--text)'; }
        }
        document.getElementById('day-avg').innerText = appData.todayAvg;
    }

    function updateGuru(price) {
        const el = document.getElementById('guru-text');
        let msg = "";
        if (settings.solar) {
            if (price > settings.highPrice) msg = "üí∞ M√º√ºgiparadiis! Pane paneelid t√§ie rauaga t√∂√∂le.";
            else if (price < 0) msg = "‚ö†Ô∏è Negatiivne hind! L√ºlita inverter v√§lja.";
            else msg = "Tootmine t√∂√∂tab. J√§lgi pilvi.";
        } else {
            if (price < 1) msg = "Tasuta elekter! üéâ K√ºta sauna.";
            else if (price < settings.lowPrice) msg = "Roheline tuli! ‚úÖ Pesumasinad t√∂√∂le.";
            else if (price > 30) msg = "R√∂√∂vlite hind! ü§¨ L√ºlita k√µik v√§lja!";
            else if (price > settings.highPrice) msg = "Kallis! üî¥ Oota tarbimisega.";
            else msg = "M√µistlik hind. üëå Tarbi rahulikult.";
        }
        if (weatherInfo.wind > 6 && price < 15) msg += " (Tuul puhub hinna alla üå¨)";
        el.innerText = msg;
    }

    function toggleSolarSettings() {
        settings.solar = document.getElementById('set-solar').checked;
        document.getElementById('solar-box').style.display = settings.solar ? 'block' : 'none';
        updateHero();
    }

    function updateSolarCalc() {
        if(!settings.solar) return;
        const capacity = parseFloat(document.getElementById('solar-capacity').value) || 0;
        settings.parkKw = capacity;
        let efficiency = 0;
        if (weatherInfo.isDay) { efficiency = (100 - weatherInfo.cloud) / 100; if (efficiency < 0.1) efficiency = 0.1; }
        const currentProd = capacity * efficiency;
        const nowTs = Math.floor(Date.now()/1000/3600)*3600;
        const currPriceObj = appData.today.find(d => d.timestamp === nowTs);
        const currentPrice = currPriceObj ? (currPriceObj.price / 10) : 0; 
        const profitPerHour = (currentProd * (currentPrice / 100)).toFixed(2); 

        document.getElementById('solar-prod').innerText = currentProd.toFixed(1) + " kW";
        document.getElementById('solar-profit').innerText = profitPerHour + " ‚Ç¨/h";
        document.getElementById('solar-desc').innerText = weatherInfo.isDay ? `Pilvisus ${weatherInfo.cloud}%` : "Pime aeg";
    }

    function renderChart() {
        const mode = document.getElementById('day-select').value;
        let data = mode === 'today' ? appData.today : appData.tomorrow;
        if (mode === 'today') { const currentH = new Date().getHours(); data = data.filter(d => new Date(d.timestamp * 1000).getHours() >= currentH); }
        if(!data.length) { document.getElementById('priceChart').style.display = 'none'; document.getElementById('no-data-msg').classList.remove('hidden'); return; }
        else { document.getElementById('priceChart').style.display = 'block'; document.getElementById('no-data-msg').classList.add('hidden'); }

        const ctx = document.getElementById('priceChart').getContext('2d');
        const labels = data.map(d => new Date(d.timestamp*1000).getHours());
        const values = data.map(d => parseFloat(calculateFinalPrice(d).toFixed(2)));
        if(chartInstance) chartInstance.destroy();

        const gradient = ctx.createLinearGradient(0, 0, 0, 400);
        gradient.addColorStop(0, 'rgba(76, 175, 80, 0.4)'); gradient.addColorStop(1, 'rgba(76, 175, 80, 0.0)');

        chartInstance = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Hind', data: values, borderWidth: 2, stepped: true, fill: true, backgroundColor: gradient, borderColor: '#4CAF50',
                    pointRadius: (ctx) => (ctx.dataIndex === 0) ? 6 : 0, pointBackgroundColor: '#4CAF50', pointBorderColor: '#fff', pointBorderWidth: 2
                }]
            },
            options: {
                responsive: true, maintainAspectRatio: false, interaction: { mode: 'index', intersect: false },
                plugins: { legend: { display: false }, tooltip: { callbacks: { label: (c) => `Hind: ${c.raw} s` } } },
                scales: { 
                    x: { grid: { display:false }, ticks: { maxTicksLimit: 8, autoSkip: true, maxRotation: 0, color: 'var(--subtext)' } }, 
                    y: { beginAtZero: true, grid: { color: getComputedStyle(document.body).getPropertyValue('--chart-grid') }, ticks: { color: 'var(--subtext)' } } 
                }
            }
        });
    }

    function getAvg(arr) {
        if(!arr.length) return 0;
        const sum = arr.reduce((acc, i) => acc + calculateFinalPrice(i), 0);
        return (sum / arr.length).toFixed(2);
    }

    function renderClock() {
        const canvas = document.getElementById('clock-canvas'); const ctx = canvas.getContext('2d');
        const dpr = window.devicePixelRatio || 1; const size = 200; canvas.width = size * dpr; canvas.height = size * dpr; ctx.scale(dpr, dpr);
        const centerX = size/2; const centerY = size/2; const radius = size/2 - 10; ctx.clearRect(0, 0, size, size);

        appData.today.forEach(item => {
            const date = new Date(item.timestamp * 1000); const hour = date.getHours(); const price = calculateFinalPrice(item);
            const startAngle = (hour * (Math.PI * 2 / 24)) + 0.05; const endAngle = ((hour + 1) * (Math.PI * 2 / 24)) - 0.05;
            ctx.beginPath(); ctx.arc(centerX, centerY, radius, startAngle, endAngle); ctx.lineCap = "round"; ctx.lineWidth = 6;
            
            if (settings.solar) {
                if (price > settings.highPrice) ctx.strokeStyle = '#FFD700'; else if (price < settings.lowPrice) ctx.strokeStyle = '#4CAF50'; else ctx.strokeStyle = getComputedStyle(document.documentElement).getPropertyValue('--clock-gray');
            } else {
                if(price < settings.lowPrice) ctx.strokeStyle = '#4CAF50'; else if(price > settings.highPrice) ctx.strokeStyle = '#FF3B30'; else ctx.strokeStyle = getComputedStyle(document.documentElement).getPropertyValue('--clock-gray');
            }
            ctx.stroke();
        });
        const currentH = new Date().getHours(); const angle = (currentH * (Math.PI * 2 / 24)) + (Math.PI / 24); 
        ctx.beginPath(); ctx.arc(centerX + (radius - 12) * Math.cos(angle), centerY + (radius - 12) * Math.sin(angle), 3, 0, Math.PI * 2);
        ctx.fillStyle = getComputedStyle(document.body).getPropertyValue('--text'); ctx.fill();
    }

    function calcSmartCharge() {
        const duration = parseInt(document.getElementById('charge-slider').value);
        document.getElementById('charge-duration-lbl').innerText = duration;
        const nowTs = Math.floor(Date.now()/1000/3600)*3600; const futureData = appData.all.filter(d => d.timestamp >= nowTs);
        if(futureData.length < duration) return;

        let bestAvg = Infinity; let bestStartItem = null;
        for(let i=0; i <= futureData.length - duration; i++) {
            let sum = 0; for(let j=0; j<duration; j++) sum += calculateFinalPrice(futureData[i+j]);
            let avg = sum / duration;
            if(avg < bestAvg) { bestAvg = avg; bestStartItem = futureData[i]; }
        }
        if(bestStartItem) {
            const d = new Date(bestStartItem.timestamp * 1000);
            document.getElementById('best-charge-time').innerText = `${d.getDate() !== new Date().getDate() ? "Homme" : "T√§na"} kell ${d.getHours()}:00`;
            document.getElementById('charge-avg-price').innerText = `Keskm. hind: ${bestAvg.toFixed(2)} s/kWh`;
        }
    }

    const devices = [
        { id: 'sauna', kw: 9, hours: 3, name: "Elektrikeris", desc: "9 kW keris, k√ºtmine 3 tundi." },
        { id: 'wash', kw: 2.5, hours: 3, name: "Pesu ja Kuivatus", desc: "Pesumasin + Kuivati (3h)." },
        { id: 'stove', kw: 2, hours: 1, name: "Elektripliit/Ahi", desc: "1 tund kokkamist (2 kW)." },
        { id: 'car', kw: 11, hours: 4, name: "Elektriauto", desc: "Kodus laadimine (11 kW), 4h." }
    ];
    function showAppInfo(id, element) {
        document.querySelectorAll('.app-item').forEach(el => el.classList.remove('selected'));
        element.classList.add('selected');
        const dev = devices.find(d => d.id === id);
        if(dev) {
            document.getElementById('info-title').innerText = dev.name;
            document.getElementById('info-text').innerText = dev.desc;
            document.getElementById('app-info-box').style.display = 'block';
        }
    }
    function updateAppliancesMatrix() {
        devices.forEach(dev => {
            const costEl = document.getElementById(`cost-${dev.id}`); const bestEl = document.getElementById(`best-${dev.id}`);
            const nowTs = Math.floor(Date.now()/1000/3600)*3600; const startIndex = appData.all.findIndex(d => d.timestamp === nowTs);
            if (startIndex !== -1 && startIndex + dev.hours <= appData.all.length) {
                let sumCurrent = 0; for(let i=0; i<dev.hours; i++) sumCurrent += calculateFinalPrice(appData.all[startIndex + i]);
                const avgCurrent = sumCurrent / dev.hours; const totalCostCurrent = avgCurrent * dev.kw * dev.hours / 100;
                costEl.innerText = totalCostCurrent.toFixed(2) + "‚Ç¨";
                if (avgCurrent > settings.highPrice) { costEl.classList.add('app-badge-expensive'); costEl.style.color = 'var(--danger)'; } 
                else { costEl.classList.remove('app-badge-expensive'); costEl.style.color = 'var(--text)'; }
                let minSum = Infinity;
                for(let i=startIndex; i <= appData.all.length - dev.hours; i++) {
                    let s = 0; for(let j=0; j<dev.hours; j++) s += calculateFinalPrice(appData.all[i+j]);
                    if(s < minSum) minSum = s;
                }
                const bestCost = (minSum / dev.hours) * dev.kw * dev.hours / 100;
                if (totalCostCurrent > bestCost * 1.1) bestEl.innerText = `Parim: ${bestCost.toFixed(2)}‚Ç¨`; else bestEl.innerText = "Parim aeg! ‚úÖ";
            } else { costEl.innerText = "--"; }
        });
    }

    async function getWeather() {
        try {
            const r = await fetch("https://api.open-meteo.com/v1/forecast?latitude=57.848&longitude=27.014&current=temperature_2m,wind_speed_10m,cloud_cover,is_day");
            const j = await r.json(); const curr = j.current;
            weatherInfo.temp = curr.temperature_2m; weatherInfo.wind = curr.wind_speed_10m / 3.6; weatherInfo.cloud = curr.cloud_cover; weatherInfo.isDay = curr.is_day;
            document.getElementById('w-temp').innerText = Math.round(weatherInfo.temp) + "¬∞";
            document.getElementById('w-wind').innerText = Math.round(weatherInfo.wind) + " m/s";
            document.getElementById('w-solar').innerText = (curr.is_day && curr.cloud_cover < 30) ? "K√µrge" : (curr.is_day && curr.cloud_cover < 70) ? "Keskm." : "Madal";
        } catch(e) {}
    }

    function openSettings() { document.getElementById('settings-modal').style.display = 'flex'; }
    function saveSettings() {
        settings.vat = parseFloat(document.getElementById('set-vat').value) / 100 + 1;
        settings.lowPrice = parseFloat(document.getElementById('set-low').value);
        settings.highPrice = parseFloat(document.getElementById('set-high').value);
        settings.network = document.getElementById('set-network').value;
        settings.solar = document.getElementById('set-solar').checked;
        localStorage.setItem('user_settings', JSON.stringify(settings));
        document.getElementById('settings-modal').style.display = 'none';
        document.getElementById('solar-box').style.display = settings.solar ? 'block' : 'none';
        if(settings.solar) document.body.classList.add('solar-mode'); else document.body.classList.remove('solar-mode');
        processElectricity(appData.all);
    }
    function loadSettings() {
        const saved = localStorage.getItem('user_settings');
        if(saved) {
            const s = JSON.parse(saved);
            document.getElementById('set-vat').value = Math.round((s.vat - 1) * 100);
            document.getElementById('set-low').value = s.lowPrice; document.getElementById('set-high').value = s.highPrice;
            document.getElementById('vat-display').innerText = document.getElementById('set-vat').value;
            document.getElementById('set-network').value = s.network || 'none';
            document.getElementById('set-solar').checked = s.solar || false;
            document.getElementById('solar-box').style.display = s.solar ? 'block' : 'none';
            settings = s;
            if(settings.theme) applyTheme();
            if(settings.solar) document.body.classList.add('solar-mode');
        }
    }
    function toggleTheme() { settings.theme = (settings.theme === 'auto') ? 'dark' : (settings.theme === 'dark' ? 'light' : 'auto'); applyTheme(); }
    function applyTheme() {
        const btn = document.getElementById('theme-toggle-btn'); const root = document.documentElement;
        if (settings.theme === 'auto') { btn.innerText = "Auto"; if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) root.setAttribute('data-theme', 'dark'); else root.removeAttribute('data-theme'); } 
        else if (settings.theme === 'dark') { btn.innerText = "Tume"; root.setAttribute('data-theme', 'dark'); } 
        else { btn.innerText = "Hele"; root.removeAttribute('data-theme'); }
        if(appData.today.length > 0) { renderClock(); renderChart(); }
    }
</script>
</body>
</html>
